{{- /* whoami-experience
     ---------------------------------------------------------------
     - Lee /data/<lang>/whoami/experience/*.toml
     - Fusiona periodos solapados/adyacentes por empresa
     - Ordena actuales primero; resto por fin descendente
     - Renderiza grupos por empresa; cada rol es colapsable (<details>)
     - Muestra duración total por empresa y por rol (ES/EN)
     --------------------------------------------------------------- -}}

{{- /* (0) Data segura */ -}}
{{- $lang := .Page.Lang | default "es" -}}
{{- $data := index site.Data $lang | default dict -}}
{{- $whoami := index $data "whoami" | default dict -}}
{{- $dir := index $whoami "experience" | default dict -}}

{{- /* (0b) Cadenas ES/EN */ -}}
{{- $isEN := eq $lang "en" -}}
{{- $yearSing := cond $isEN "year" "año" -}}
{{- $yearPlur := cond $isEN "years" "años" -}}
{{- $monthSing := cond $isEN "month" "mes" -}}
{{- $monthPlur := cond $isEN "months" "meses" -}}
{{- $andWord := cond $isEN "and" "y" -}}

{{- /* (1) Normalizar y marcar actuales */ -}}
{{- $items := slice -}}
{{- range $k, $v := $dir }}
  {{- $end := $v.end | default "" -}}
  {{- $isCurrent := or (eq (lower (print $end)) "presente") (eq (lower (print $end)) "present") -}}
  {{- $items = $items | append (merge $v (dict "_isCurrent" $isCurrent)) -}}
{{- end -}}

{{- /* (2) Agrupar por empresa */ -}}
{{- $byCompany := dict -}}
{{- range $items -}}
  {{- $cid := or .company_id (.company | urlize) -}}
  {{- $arr := (index $byCompany $cid) | default (slice) -}}
  {{- $arr = $arr | append . -}}
  {{- $byCompany = merge $byCompany (dict $cid $arr) -}}
{{- end -}}

{{- /* (3) Fusionar solapes/adyacentes por empresa */ -}}
{{- $segments := slice -}}
{{- range $cid, $rolesAll := $byCompany -}}
  {{- $roles := sort $rolesAll "start" "asc" -}}

  {{- $segRoles := slice -}}
  {{- $segStart := "" -}}
  {{- $segEndDisplay := "" -}}
  {{- $segEndComp := "" -}}
  {{- $segIsCurrent := false -}}

  {{- range $roles -}}
    {{- $rStart := .start -}}
    {{- $rEndDisplay := .end | default "" -}}
    {{- $rEndLower := lower (print $rEndDisplay) -}}
    {{- $rEndComp := cond (or (eq $rEndLower "presente") (eq $rEndLower "present")) "9999-12" $rEndDisplay -}}
    {{- $rIsCurrent := or (eq $rEndLower "presente") (eq $rEndLower "present") -}}

    {{- if eq (len $segRoles) 0 -}}
      {{- $segRoles = slice . -}}
      {{- $segStart = $rStart -}}
      {{- $segEndDisplay = $rEndDisplay -}}
      {{- $segEndComp = $rEndComp -}}
      {{- $segIsCurrent = $rIsCurrent -}}
    {{- else -}}
      {{- $segParts := split $segEndComp "-" -}}
      {{- $segY := int (index $segParts 0) -}}
      {{- $segM := int (replaceRE "^0+" "" (index $segParts 1)) -}}
      {{- $segIdx := add (mul $segY 12) $segM -}}

      {{- $rParts := split $rStart "-" -}}
      {{- $rY := int (index $rParts 0) -}}
      {{- $rM := int (replaceRE "^0+" "" (index $rParts 1)) -}}
      {{- $rIdx := add (mul $rY 12) $rM -}}

      {{- $isAdjacent := eq $rIdx (add $segIdx 1) -}}
      {{- $overlapOrSame := le $rIdx $segIdx -}}

      {{- if or $overlapOrSame $isAdjacent -}}
        {{- $segRoles = $segRoles | append . -}}
        {{- if lt $segEndComp $rEndComp -}}
          {{- $segEndComp = $rEndComp -}}
          {{- $segEndDisplay = $rEndDisplay -}}
        {{- end -}}
        {{- if $rIsCurrent -}}{{- $segIsCurrent = true -}}{{- end -}}
      {{- else -}}
        {{- $segments = $segments | append (dict
            "company"    (index $segRoles 0).company
            "company_id" (or (index $segRoles 0).company_id ((index $segRoles 0).company | urlize))
            "roles"      (sort $segRoles "start" "asc")
            "_startMin"  $segStart
            "_endMax"    $segEndDisplay
            "_endComp"   $segEndComp
            "_isCurrent" $segIsCurrent
          ) -}}
        {{- $segRoles = slice . -}}
        {{- $segStart = $rStart -}}
        {{- $segEndDisplay = $rEndDisplay -}}
        {{- $segEndComp = $rEndComp -}}
        {{- $segIsCurrent = $rIsCurrent -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if gt (len $segRoles) 0 -}}
    {{- $segments = $segments | append (dict
        "company"    (index $segRoles 0).company
        "company_id" (or (index $segRoles 0).company_id ((index $segRoles 0).company | urlize))
        "roles"      (sort $segRoles "start" "asc")
        "_startMin"  $segStart
        "_endMax"    $segEndDisplay
        "_endComp"   $segEndComp
        "_isCurrent" $segIsCurrent
      ) -}}
  {{- end -}}
{{- end -}}

{{- /* (4) Año/Mes actual + duración para ordenar */ -}}
{{- $ny := int (dateFormat "2006" now) -}}
{{- $nm := int (dateFormat "1"   now) -}} {{/* mes sin cero inicial */}}
{{- $enriched := slice -}}
{{- range $segments -}}
  {{- $durMonths := 0 -}}
  {{- if ._isCurrent -}}
    {{- $parts := split ._startMin "-" -}}
    {{- $sy := int (index $parts 0) -}}
    {{- $sm := int (replaceRE "^0+" "" (index $parts 1)) -}}
    {{- $nowMon := add (mul $ny 12) $nm -}}
    {{- $begMon := add (mul $sy 12) $sm -}}
    {{- $durMonths = sub $nowMon $begMon -}}
  {{- end -}}
  {{- $enriched = $enriched | append (merge . (dict "_durMonths" $durMonths)) -}}
{{- end -}}

{{- /* (5) Orden global */ -}}
{{- $currents := where $enriched "_isCurrent" true -}}
{{- $noncurr  := where $enriched "_isCurrent" false -}}
{{- $currents = sort (sort $currents "_durMonths" "desc") "_startMin" "asc" -}}
{{- $noncurr  = sort $noncurr "_endComp" "desc" -}}
{{- $ordered := $currents -}}
{{- range $noncurr }}{{- $ordered = $ordered | append . -}}{{- end -}}

{{- /* (6) Diccionario de compañías e i18n del título */ -}}
{{- $companies := index $whoami "companies" | default dict -}}
{{- $title := i18n "whoami_experience" | default (cond $isEN "Experience" "Experiencia") -}}

<section class="whoami-exp">
  <h2 class="whoami-exp__title">{{ $title }}</h2>
  <div class="whoami-exp__groups">
    {{- range $ordered -}}
      {{- $cid := .company_id -}}
      {{- $meta := index $companies $cid | default dict -}}
      {{- $name := or $meta.name .company -}}

      {{- /* Logo */ -}}
      {{- $companyFile := printf "images/corp/%s.png" (lower $cid) -}}
      {{- $companyFs   := printf "static/%s" $companyFile -}}
      {{- $logo := cond (fileExists $companyFs) $companyFile "images/logo.png" -}}

      {{- /* Periodo total de la empresa */ -}}
      {{- $rolesAsc := sort .roles "start" "asc" -}}
      {{- $periodStart := index (index $rolesAsc 0) "start" -}}
      {{- $periodEnd   := (index (index (last 1 $rolesAsc) 0) "end") | default "" -}}

      {{- /* URL final de empresa */ -}}
      {{- $companyURL := or $meta.url "" -}}
      {{- range $rolesAsc -}}
        {{- with .url -}}{{- $companyURL = . -}}{{- end -}}
      {{- end -}}

      {{- /* Duración empresa (seguro; sin cond para parse) */ -}}
      {{- $psParts := split $periodStart "-" -}}
      {{- $psy := int (index $psParts 0) -}}
      {{- $psm := int (replaceRE "^0+" "" (index $psParts 1)) -}}
      {{- $peLower := lower (print $periodEnd) -}}
      {{- $pey := 0 -}}{{- $pem := 0 -}}
      {{- if or (eq $peLower "presente") (eq $peLower "present") (eq (trim $periodEnd " \t\r\n") "") -}}
        {{- $pey = $ny -}}
        {{- $pem = $nm -}}
      {{- else -}}
        {{- $peParts := split $periodEnd "-" -}}
        {{- $pey = int (index $peParts 0) -}}
        {{- $pem = int (replaceRE "^0+" "" (index $peParts 1)) -}}
      {{- end -}}
      {{- $pBeg := add (mul $psy 12) $psm -}}
      {{- $pEnd := add (mul $pey 12) $pem -}}
      {{- $pMonths := add (sub $pEnd $pBeg) 1 -}}
      {{- $pYears := div $pMonths 12 -}}
      {{- $pRem := mod $pMonths 12 -}}
      {{- $pDur := "" -}}
      {{- if ge $pMonths 12 -}}
        {{- $pDur = printf "%d %s" $pYears (cond (eq $pYears 1) $yearSing $yearPlur) -}}
        {{- if gt $pRem 0 -}}
          {{- $pDur = printf "%s %s %d %s" $pDur $andWord $pRem (cond (eq $pRem 1) $monthSing $monthPlur) -}}
        {{- end -}}
      {{- else -}}
        {{- $pDur = printf "%d %s" $pMonths (cond (eq $pMonths 1) $monthSing $monthPlur) -}}
      {{- end -}}

      <article class="whoami-company">
        <header class="whoami-company__header">
          <div class="whoami-company__logo">
            {{- if $companyURL -}}<a href="{{ $companyURL }}" target="_blank" rel="noopener">{{- end -}}
              <img src="{{ $logo | relURL }}" alt="{{ $name }} logo" loading="lazy" />
            {{- if $companyURL -}}</a>{{- end -}}
          </div>
          <div class="whoami-company__meta">
            <div class="whoami-company__name">
              {{- if $companyURL -}}
                <a href="{{ $companyURL }}" target="_blank" rel="noopener">{{ $name }}</a>
              {{- else -}}
                {{ $name }}
              {{- end -}}
            </div>
            <div class="whoami-company__period">
              {{ $periodStart }} — {{ $periodEnd }}
              <span class="whoami-duration">({{ $pDur }})</span>
            </div>
          </div>
        </header>

        {{- /* (7) Orden interno de roles */ -}}
        {{- $rolesDisp := slice -}}
        {{- range $rolesAsc }}
          {{- $endLower := lower (print .end) -}}
          {{- $endComp  := cond (or (eq $endLower "presente") (eq $endLower "present"))
                               "9999-12"
                               (.end | default "0000-00") -}}
          {{- $rolesDisp = $rolesDisp | append (merge . (dict "_endComp" $endComp)) -}}
        {{- end -}}
        {{- $rolesDisp = sort (sort $rolesDisp "_endComp" "desc") "start" "desc" -}}

        <div class="whoami-timeline">
          {{- range $rolesDisp -}}
            {{- $ri := or .role_icon "images/logo.png" -}}
            {{- $riFs := printf "static/%s" (trim $ri "/") -}}
            {{- $roleIcon := cond (fileExists $riFs) $ri "images/logo.png" -}}

            {{- $endLower := lower (print .end) -}}
            {{- $isCurrentRole := or (eq $endLower "presente") (eq $endLower "present") -}}

            {{- /* Duración por rol (seguro; sin cond para parse) */ -}}
            {{- $rsParts := split .start "-" -}}
            {{- $rsy := int (index $rsParts 0) -}}
            {{- $rsm := int (replaceRE "^0+" "" (index $rsParts 1)) -}}
            {{- $rey := 0 -}}{{- $rem := 0 -}}
            {{- if or (eq $endLower "presente") (eq $endLower "present") (eq (trim (.end | default "") " \t\r\n") "") -}}
              {{- $rey = $ny -}}
              {{- $rem = $nm -}}
            {{- else -}}
              {{- $reParts := split (.end | default "0000-00") "-" -}}
              {{- $rey = int (index $reParts 0) -}}
              {{- $rem = int (replaceRE "^0+" "" (index $reParts 1)) -}}
            {{- end -}}
            {{- $rBeg := add (mul $rsy 12) $rsm -}}
            {{- $rEnd := add (mul $rey 12) $rem -}}
            {{- $rMonths := add (sub $rEnd $rBeg) 1 -}}
            {{- $rYears := div $rMonths 12 -}}
            {{- $rRema := mod $rMonths 12 -}}
            {{- $rDur := "" -}}
            {{- if ge $rMonths 12 -}}
              {{- $rDur = printf "%d %s" $rYears (cond (eq $rYears 1) $yearSing $yearPlur) -}}
              {{- if gt $rRema 0 -}}
                {{- $rDur = printf "%s %s %d %s" $rDur $andWord $rRema (cond (eq $rRema 1) $monthSing $monthPlur) -}}
              {{- end -}}
            {{- else -}}
              {{- $rDur = printf "%d %s" $rMonths (cond (eq $rMonths 1) $monthSing $monthPlur) -}}
            {{- end -}}

            <div class="whoami-role">
              <div class="whoami-role__dot">
                <img src="{{ $roleIcon | relURL }}" alt="role icon" />
              </div>

              <details class="whoami-role__body">
                <summary class="whoami-role__summary">
                  <span class="whoami-role__title">{{ .title }}</span>
                  <span class="whoami-role__dates">
                    {{ .start }} — {{ .end }}
                    <span class="whoami-duration">({{ $rDur }})</span>
                  </span>
                </summary>

                {{- with .highlights -}}
                  <ul class="whoami-role__highlights">
                    {{- range . -}}<li>{{ . }}</li>{{- end -}}
                  </ul>
                {{- end -}}
              </details>
            </div>
          {{- end -}}
        </div>
      </article>
    {{- end -}}
  </div>
</section>
